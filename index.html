<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç¨‹å­æ´¢-ç½—å¿—é‘«ï¼Œç‰µæ‰‹åˆ°æ°¸è¿œ</title>
<style>
  :root{
    --bg-1:#0b0710;
    --bg-2:#261025;
    --card-bg: rgba(255,255,255,0.95);
    --msg-color: #111112;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));font-family:'Segoe UI','PingFang SC',system-ui,sans-serif;color:#fff;overflow:hidden}
  canvas#bg{position:fixed;inset:0;width:100%;height:100%;z-index:0;display:block}
  .center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:2;pointer-events:none;width:min(56vmin,640px);height:min(56vmin,640px);display:grid;align-items:center;justify-items:center;}
  .heart-svg{width:100%;height:100%;filter:drop-shadow(0 18px 40px rgba(0,0,0,0.6));animation:pulse 1400ms ease-in-out infinite}
  @keyframes pulse{0%{transform:scale(0.98)}50%{transform:scale(1)}100%{transform:scale(0.98)}}
  #barrage{position:fixed;inset:0;z-index:3;pointer-events:none}
  .msg{position:absolute;pointer-events:auto;background:var(--card-bg);color:var(--msg-color);padding:12px 14px;border-radius:16px;max-width:360px;
    box-shadow:0 12px 30px rgba(0,0,0,0.45);opacity:0;transform:translateY(12px) scale(0.995);
    transition:opacity 450ms ease, transform 450ms ease;font-size:16px;line-height:1.4;}
  .msg.show{opacity:1;transform:translateY(0) scale(1)}
  .controls{position:fixed;right:18px;bottom:18px;z-index:6;display:flex;gap:10px;align-items:center;}
  .btn{background:rgba(255,255,255,0.9);color:#111;border:0;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600;
    box-shadow:0 6px 16px rgba(0,0,0,0.3);}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>

<canvas id="bg" aria-hidden="true"></canvas>

<div class="center" aria-hidden="true">
  <svg class="heart-svg" viewBox="0 0 100 100" role="img" aria-label="è·³åŠ¨çš„å¿ƒå½¢">
    <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0%" stop-color="#ffb0c0"/><stop offset="100%" stop-color="#ff6a86"/></linearGradient></defs>
    <g transform="translate(50,50) scale(0.9)">
      <path d="M0 -22 C -12 -40 -40 -32 -40 -6 C -40 18 -4 36 0 46 C 4 36 40 18 40 -6 C 40 -32 12 -40 0 -22 Z" fill="url(#g)"></path>
    </g>
  </svg>
</div>

<div id="barrage" aria-live="polite" aria-atomic="true"></div>

<div class="controls" role="region" aria-label="æ’­æ”¾æ§åˆ¶">
  <button id="musicBtn" class="btn" aria-pressed="false" title="æ’­æ”¾ / æš‚åœéŸ³ä¹">ğŸµ æ’­æ”¾</button>
  <button id="pauseBtn" class="btn" aria-pressed="false" title="æš‚åœ / æ¢å¤å¼¹å¹•">â¯ æš‚åœå¼¹å¹•</button>
</div>

<div id="sr" class="sr-only" aria-hidden="false"></div>

<script>
/* === å…¨å±€å…ƒç´  === */
const barrage = document.getElementById('barrage');
const sr = document.getElementById('sr');
const musicBtn = document.getElementById('musicBtn');
const pauseBtn = document.getElementById('pauseBtn');

/* === éŸ³ä¹æ§åˆ¶ === */
// ç¡®ä¿ä½ çš„éŸ³ä¹é“¾æ¥æ˜¯æœ‰æ•ˆçš„ï¼Œä¾‹å¦‚ï¼š
const audio = new Audio('special_person.mp3'); // åŒç›®å½•ä¸‹
audio.preload = 'auto';
audio.volume = 0.32;
let audioPlayed = false;

// éŸ³ä¹æ’­æ”¾ç»“æŸå
audio.addEventListener('ended',()=>{
  audioPlayed = true;
  musicBtn.textContent='ğŸµ æ’­æ”¾';
  musicBtn.setAttribute('aria-pressed','false');
});

// æ’­æ”¾/æš‚åœæŒ‰é’®
musicBtn.addEventListener('click', async ()=>{
  if(audio.paused){
    try{
      await audio.play();
      musicBtn.textContent='ğŸ”‡ æš‚åœ';
      musicBtn.setAttribute('aria-pressed','true');
    }catch(e){
      alert('æµè§ˆå™¨é˜»æ­¢è‡ªåŠ¨æ’­æ”¾ï¼Œè¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®ã€‚');
    }
  }else{
    audio.pause();
    musicBtn.textContent='ğŸµ æ’­æ”¾';
    musicBtn.setAttribute('aria-pressed','false');
  }
});

// é¡µé¢åŠ è½½æ—¶å°è¯•æ’­æ”¾
window.addEventListener('load',()=>{
  audio.play().then(()=>{
    musicBtn.textContent='ğŸ”‡ æš‚åœ';
    musicBtn.setAttribute('aria-pressed','true');
  }).catch(()=>{});
});

/* === å¼¹å¹•æ±  === */
const ORIGINAL_MESSAGES=[
'è´è´ï¼Œä½ åœ¨æˆ‘çœ¼ä¸­æ˜¯æœ€ç¾ã€‚','å’Œä½ åœ¨ä¸€èµ·ä»¿ä½›ä¸–ç•Œè¢«ç‚¹äº®äº†ã€‚','æˆ‘æƒ³è®©ä½ æ— æ—¶æ— åˆ»éƒ½æƒ³å’Œæˆ‘åœ¨ä¸€èµ·ï¼Œå°±åƒæˆ‘æƒ³ä½ é‚£æ ·ã€‚',
'ä½ ä¸ç”¨æ‹…å¿ƒæˆ‘ä»¬çš„çˆ±æ„ä¼šè¢«æ—¶é—´æ¶ˆç£¨ï¼Œå› ä¸ºæ¯å¤©é†’æ¥éƒ½ä¼šè¢«æ³¨å…¥æ›´å¤šçˆ±æ„ï¼Œåªä¼šè¶Šæ¥è¶Šå¤šã€‚','æˆ‘åœ¨ä¹çš„æ˜¯ä½ èˆ’ä¸èˆ’æœå¥ä¸å¥åº·ï¼Œè€Œä¸æ˜¯ç¾ä¸ç¾ç˜¦ä¸ç˜¦ï¼Œæ‰€ä»¥å¸Œæœ›ä½ å¥½å¥½åƒé¥­å¥½å¥½ç¡è§‰ã€‚',
'æˆ‘çˆ±ä½ ã€‚','ä¸€ç”Ÿä¸€ä¸–ä¸€åŒäººï¼Œä¸€å¿ƒä¸€æ„ä¸€ä¸ªäººã€‚','å› ä¸ºä½ æˆ‘ç›¸ä¿¡æˆ‘çš„æœªæ¥ä¸€å®šä¼šè¿‡å¾—å¾ˆå¥½ã€‚','æ´¢æ´¢å®è´æ¯å¤©éƒ½å¼€å¿ƒã€‚','ç¼˜å®šæ­¤ç”Ÿï¼Œç¼˜å®šæ­¤äººã€‚',
'æ¯ä¸€æ¬¡å¿ƒè·³éƒ½æ˜¯çˆ±ä½ çš„å›å“ã€‚','æˆ‘ä¿©å¤©ä¸‹ç¬¬ä¸€å¥½ï¼','è¦è¿™æ ·ä¸€ç›´å¹¸ç¦ä¸‹å»ã€‚','çˆ±ä¸Šäº†ä½ ï¼Œä»æ­¤çœ¼ä¸­å†æ— ä»–äººã€‚',
'çˆ±äººå¯¹æˆ‘æ¥è¯´ä¸æ˜¯é€‰æ‹©é¢˜ï¼Œè€Œæ˜¯ç”¨å¿ƒæ‰“ç£¨åçš„å¡«ç©ºï¼Œå¿ƒä¸Šæœ‰äº†ä½ å°±å·²ç»äº¤å·äº†ï¼Œæˆ‘å¸Œæœ›ä½ ä¹Ÿæ˜¯ã€‚','æˆ‘æƒ³æˆä¸ºä½ çš„å”¯ä¸€ï¼Œå› ä¸ºä½ å¯¹æˆ‘æ¥è¯´å°±æ˜¯ã€‚','ç¨‹å­æ´¢ï¼Œæˆ‘æƒ³ä¸€ç›´å’Œä½ åœ¨ä¸€èµ·ã€‚'
];

const DISPLAY_TIME=7000,MAX_SIMULTANEOUS=3,INITIAL_BURST=6,BATCH_MIN=2,BATCH_MAX=3,TRY_POS_ATTEMPTS=12;
let pool=[];function refillPool(){pool=shuffle([...ORIGINAL_MESSAGES]);}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
refillPool();

function getVisibleRects(){
  return Array.from(barrage.children).map(el=>{
    const r=el.getBoundingClientRect();
    return {left:r.left,right:r.right,top:r.top,bottom:r.bottom};
  });
}
function overlaps(x,y,w,h,existing,margin=8){
  for(const e of existing){
    if(!(x+w+margin<e.left||x>e.right+margin||y+h+margin<e.top||y>e.bottom+margin))return true;
  }return false;
}
function findPositionFor(el){
  const vw=window.innerWidth,vh=window.innerHeight;
  const r=el.getBoundingClientRect(),w=r.width,h=r.height;
  const existing=getVisibleRects();
  for(let i=0;i<TRY_POS_ATTEMPTS;i++){
    const x=Math.random()*(vw-w-40)+20,y=Math.random()*(vh-h-40)+20;
    if(!overlaps(x,y,w,h,existing))return{x,y};
  }return{x:Math.random()*(vw-w-40)+20,y:Math.random()*(vh-h-40)+20};
}
function randomSoftBackground(){
  const h=330+Math.random()*40,s=70+Math.random()*10,l=85-Math.random()*6;
  return`hsl(${h} ${s}% ${l}%)`;
}
function showSingleMessage(text){
  const el=document.createElement('div');
  el.className='msg';el.textContent=text;barrage.appendChild(el);
  requestAnimationFrame(()=>{
    const pos=findPositionFor(el);
    el.style.left=pos.x+'px';el.style.top=pos.y+'px';el.style.background=randomSoftBackground();
    el.classList.add('show');sr.textContent=text;
    setTimeout(()=>{el.classList.remove('show');setTimeout(()=>el.remove(),400);},DISPLAY_TIME);
  });
}
function showBatch(){
  if(paused)return;
  const cur=barrage.children.length;
  if(cur>=MAX_SIMULTANEOUS)return;
  const n=Math.min(BATCH_MAX,Math.max(BATCH_MIN,Math.floor(Math.random()*(BATCH_MAX-BATCH_MIN+1))+BATCH_MIN-1));
  for(let i=0;i<n;i++){if(pool.length===0)refillPool();showSingleMessage(pool.pop());}
}
function initialBurst(){
  let t=120;
  for(let i=0;i<INITIAL_BURST;i++){setTimeout(()=>{if(pool.length===0)refillPool();showSingleMessage(pool.pop());},t);t+=220;}
}

let loopTimer=null,paused=false;
function startLoop(){if(loopTimer)clearInterval(loopTimer);loopTimer=setInterval(()=>{if(!document.hidden&&!paused)showBatch();},2600);}
pauseBtn.addEventListener('click',()=>{paused=!paused;pauseBtn.textContent=paused?'â–¶ æ¢å¤å¼¹å¹•':'â¯ æš‚åœå¼¹å¹•';});

/* èƒŒæ™¯èŠ±ç“£ */
const canvas=document.getElementById('bg'),ctx=canvas.getContext('2d');
let W=canvas.width=innerWidth,H=canvas.height=innerHeight;
window.addEventListener('resize',()=>{W=canvas.width=innerWidth;H=canvas.height=innerHeight;});
const petals=[];for(let i=0;i<48;i++)petals.push(makePetal());
function makePetal(){return{x:Math.random()*W,y:Math.random()*H,r:6+Math.random()*10,vx:-0.3+Math.random()*0.6,vy:0.2+Math.random()*0.8,rot:Math.random()*Math.PI*2,rotSpeed:(Math.random()-0.5)*0.02,hue:330+Math.random()*30,alpha:0.6+Math.random()*0.3};}
function drawBg(){
  ctx.clearRect(0,0,W,H);
  for(const p of petals){
    ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);
    ctx.fillStyle=`hsla(${p.hue},70%,85%,${p.alpha})`;
    ctx.beginPath();ctx.ellipse(0,0,p.r*0.9,p.r*0.6,0,0,Math.PI*2);ctx.fill();ctx.restore();
    p.x+=p.vx+Math.sin(p.y/30)*0.2;p.y+=p.vy;p.rot+=p.rotSpeed;
    if(p.y>H+20){Object.assign(p,makePetal());p.y=-20;p.x=Math.random()*W;}
  }
  requestAnimationFrame(drawBg);
}

/* å¯åŠ¨ */
initialBurst();startLoop();drawBg();
</script>
</body>
</html>
