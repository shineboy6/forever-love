<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç¨‹å­æ´¢ â€” çˆ±æ„æ»¡å±</title>
<style>
  :root{
    --bg-1:#0b0710;
    --bg-2:#261025;
    --card-bg: rgba(255,255,255,0.95);
    --msg-color: #111112;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));font-family: 'Segoe UI', 'PingFang SC', system-ui, sans-serif;color:#fff;overflow:hidden}
  /* canvas èƒŒæ™¯ (èŠ±ç“£/å…‰æ•ˆ) */
  canvas#bg{position:fixed;inset:0;width:100%;height:100%;z-index:0;display:block}
  /* ä¸­å¿ƒå¿ƒå½¢ */
  .center{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:2;pointer-events:none;
    width:min(56vmin,640px);height:min(56vmin,640px);display:grid;align-items:center;justify-items:center;
  }
  .heart-svg{width:100%;height:100%;filter:drop-shadow(0 18px 40px rgba(0,0,0,0.6));animation:pulse 1400ms ease-in-out infinite}
  @keyframes pulse{0%{transform:scale(0.98)}50%{transform:scale(1)}100%{transform:scale(0.98)}}
  /* å¼¹å¹•å®¹å™¨ */
  #barrage{position:fixed;inset:0;z-index:3;pointer-events:none}
  .msg{
    position:absolute;
    pointer-events:auto;
    background:var(--card-bg);
    color:var(--msg-color);
    padding:12px 14px;
    border-radius:16px;
    max-width:360px;
    box-shadow:0 12px 30px rgba(0,0,0,0.45);
    opacity:0; transform:translateY(12px) scale(0.995);
    transition:opacity 450ms ease, transform 450ms ease;
    font-size:16px; line-height:1.4;
  }
  .msg.show{opacity:1;transform:translateY(0) scale(1)}
  .controls{
    position:fixed;right:18px;bottom:18px;z-index:6;display:flex;gap:10px;align-items:center;
  }
  .btn{
    background:rgba(255,255,255,0.9);color:#111;border:0;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600;
    box-shadow:0 6px 16px rgba(0,0,0,0.3);
  }
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  @media (prefers-reduced-motion:reduce){.heart-svg, .msg{transition:none!important;animation:none!important}}
</style>
</head>
<body>

<canvas id="bg" aria-hidden="true"></canvas>

<div class="center" aria-hidden="true">
  <!-- SVG å¿ƒå½¢ -->
  <svg class="heart-svg" viewBox="0 0 100 100" role="img" aria-label="è·³åŠ¨çš„å¿ƒå½¢">
    <defs>
      <linearGradient id="g" x1="0" x2="1">
        <stop offset="0%" stop-color="#ffb0c0"/>
        <stop offset="100%" stop-color="#ff6a86"/>
      </linearGradient>
    </defs>
    <g transform="translate(50,50) scale(0.9)">
      <path d="M0 -22 C -12 -40 -40 -32 -40 -6 C -40 18 -4 36 0 46 C 4 36 40 18 40 -6 C 40 -32 12 -40 0 -22 Z" fill="url(#g)"></path>
    </g>
  </svg>
</div>

<div id="barrage" aria-live="polite" aria-atomic="true"></div>

<div class="controls" role="region" aria-label="æ’­æ”¾æ§åˆ¶">
  <button id="musicBtn" class="btn" aria-pressed="false" title="æ’­æ”¾ / æš‚åœéŸ³ä¹">ğŸµ æ’­æ”¾</button>
  <button id="pauseBtn" class="btn" aria-pressed="false" title="æš‚åœ / æ¢å¤å¼¹å¹•">â¯ æš‚åœå¼¹å¹•</button>
</div>

<div id="sr" class="sr-only" aria-hidden="false"></div>

<script>
/* ---------------------
  ä½¿ç”¨è¯´æ˜
  - è¯·æŠŠéŸ³ä¹æ–‡ä»¶å‘½åä¸º special_person.mp3 å¹¶ä¸æ­¤ HTML æ”¾åœ¨åŒä¸€ç›®å½•ã€‚
  - åŒå‡»æ‰“å¼€æ–‡ä»¶æˆ–éƒ¨ç½²åˆ°é™æ€æœåŠ¡å™¨å³å¯ã€‚
----------------------*/

/* æ¶ˆæ¯æ± ï¼ˆä½ æä¾›çš„é‚£äº›å¥å­ï¼‰ */
const ORIGINAL_MESSAGES = [
  'è´è´ï¼Œä½ åœ¨æˆ‘çœ¼ä¸­æ˜¯æœ€ç¾ã€‚',
  'å’Œä½ åœ¨ä¸€èµ·ä»¿ä½›ä¸–ç•Œè¢«ç‚¹äº®äº†ã€‚',
  'æˆ‘æƒ³è®©ä½ æ— æ—¶æ— åˆ»éƒ½æƒ³å’Œæˆ‘åœ¨ä¸€èµ·ï¼Œå°±åƒæˆ‘æƒ³ä½ é‚£æ ·ã€‚',
  'ä½ ä¸ç”¨æ‹…å¿ƒæˆ‘ä»¬çš„çˆ±æ„ä¼šè¢«æ—¶é—´æ¶ˆç£¨ï¼Œå› ä¸ºæ¯å¤©é†’æ¥éƒ½ä¼šè¢«æ³¨å…¥æ›´å¤šçˆ±æ„ï¼Œåªä¼šè¶Šæ¥è¶Šå¤šã€‚',
  'æˆ‘åœ¨ä¹çš„æ˜¯ä½ èˆ’ä¸èˆ’æœå¥ä¸å¥åº·ï¼Œè€Œä¸æ˜¯ç¾ä¸ç¾ç˜¦ä¸ç˜¦ï¼Œæ‰€ä»¥å¸Œæœ›ä½ å¥½å¥½åƒé¥­å¥½å¥½ç¡è§‰ã€‚',
  'æˆ‘çˆ±ä½ ã€‚',
  'ä¸€ç”Ÿä¸€ä¸–ä¸€åŒäººï¼Œä¸€å¿ƒä¸€æ„ä¸€ä¸ªäººã€‚',
  'å› ä¸ºä½ æˆ‘ç›¸ä¿¡æˆ‘çš„æœªæ¥ä¸€å®šä¼šè¿‡å¾—å¾ˆå¥½ã€‚',
  'æ´¢æ´¢å®è´æ¯å¤©éƒ½å¼€å¿ƒã€‚',
  'ç¼˜å®šæ­¤ç”Ÿï¼Œç¼˜å®šæ­¤äººã€‚',
  'æ¯ä¸€æ¬¡å¿ƒè·³éƒ½æ˜¯çˆ±ä½ çš„å›å“ã€‚',
  'æˆ‘ä¿©å¤©ä¸‹ç¬¬ä¸€å¥½ï¼',
  'è¦è¿™æ ·ä¸€ç›´å¹¸ç¦ä¸‹å»ã€‚',
  'çˆ±ä¸Šäº†ä½ ï¼Œä»æ­¤çœ¼ä¸­å†æ— ä»–äººã€‚',
  'çˆ±äººå¯¹æˆ‘æ¥è¯´ä¸æ˜¯é€‰æ‹©é¢˜ï¼Œè€Œæ˜¯ç”¨å¿ƒæ‰“ç£¨åçš„å¡«ç©ºï¼Œå¿ƒä¸Šæœ‰äº†ä½ å°±å·²ç»äº¤å·äº†ï¼Œæˆ‘å¸Œæœ›ä½ ä¹Ÿæ˜¯ã€‚',
  'æˆ‘æƒ³æˆä¸ºä½ çš„å”¯ä¸€ï¼Œå› ä¸ºä½ å¯¹æˆ‘æ¥è¯´å°±æ˜¯ã€‚',
  'ç¨‹å­æ´¢ï¼Œæˆ‘æƒ³ä¸€ç›´å’Œä½ åœ¨ä¸€èµ·ã€‚'
];

/* é…ç½® */
const DISPLAY_TIME = 7000;      // æ¯æ¡æ¶ˆæ¯åœç•™ (ms)
const MAX_SIMULTANEOUS = 3;    // å±å¹•ä¸Šæœ€å¤šå‡ æ¡æ¶ˆæ¯
const INITIAL_BURST = 6;       // åˆå§‹é“ºé¢æ¡æ•°
const BATCH_MIN = 2;           // æ¯æ¬¡å±•ç¤ºæœ€å°‘æ¡æ•°
const BATCH_MAX = 3;           // æ¯æ¬¡å±•ç¤ºæœ€å¤šæ¡æ•°
const TRY_POS_ATTEMPTS = 12;   // æ‰¾ä¸é‡å ä½ç½®å°è¯•æ¬¡æ•°

/* DOM */
const barrage = document.getElementById('barrage');
const sr = document.getElementById('sr');
const musicBtn = document.getElementById('musicBtn');
const pauseBtn = document.getElementById('pauseBtn');

/* éŸ³ä¹ï¼šå°è¯•åŠ è½½åŒç›®å½•çš„ special_person.mp3 */
const audio = new Audio('special_person.mp3');
audio.preload = 'auto';
audio.volume = 0.32;
let audioPlayed = false; // æˆ‘ä»¬å¸Œæœ›æ’­æ”¾ä¸€æ¬¡

audio.addEventListener('ended', ()=>{
  // æ’­æ”¾ä¸€æ¬¡åä¸å¾ªç¯
  audioPlayed = true;
  musicBtn.textContent = 'ğŸµ æ’­æ”¾';
  musicBtn.setAttribute('aria-pressed','false');
});

/* å½“é¡µé¢å…è®¸è‡ªåŠ¨æ’­æ”¾å¤±è´¥æ—¶ï¼Œç”¨æˆ·ç‚¹å‡»æ’­æ”¾æŒ‰é’®å³å¯ */
musicBtn.addEventListener('click', async ()=>{
  if (audio.paused && !audioPlayed) {
    try {
      await audio.play();
      musicBtn.textContent = 'ğŸ”‡ æš‚åœ';
      musicBtn.setAttribute('aria-pressed','true');
    } catch(e) {
      // æµè§ˆå™¨é˜»æ­¢ï¼Œæç¤ºç”¨æˆ·ä¸é¡µé¢äº¤äº’
      alert('æµè§ˆå™¨é˜»æ­¢è‡ªåŠ¨æ’­æ”¾ã€‚è¯·å…ˆå…è®¸æˆ–åœ¨é¡µé¢ç‚¹å‡»æ’­æ”¾ã€‚');
    }
  } else {
    audio.pause();
    musicBtn.textContent = 'ğŸµ æ’­æ”¾';
    musicBtn.setAttribute('aria-pressed','false');
  }
});

/* å°è¯•åœ¨åŠ è½½æ—¶è‡ªåŠ¨æ’­æ”¾ï¼ˆå¤šæµè§ˆå™¨å¯èƒ½è¢«é˜»æ­¢ï¼‰ */
window.addEventListener('load', ()=>{
  audio.play().then(()=>{ musicBtn.textContent='ğŸ”‡ æš‚åœ'; musicBtn.setAttribute('aria-pressed','true'); })
    .catch(()=>{/*æ— åŠ¨ä½œï¼šç­‰å¾…ç”¨æˆ·ç‚¹å‡»*/});
});

/* å¼¹å¹•æ¶ˆæ¯ç®¡ç†ï¼šéšæœºæŠ½å–ä¸”æ— é‡å¤ç›´åˆ°æ± ç©º */
let pool = [];
function refillPool(){ pool = shuffle([...ORIGINAL_MESSAGES]); }
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}
refillPool();

/* å½“å‰å¯è§æ¶ˆæ¯å…ƒç´ åˆ—è¡¨ï¼ˆç”¨äºç¢°æ’æ£€æµ‹ï¼‰ */
function getVisibleRects(){
  return Array.from(barrage.children).filter(c=>c.dataset.dismiss!=='1').map(el=>{
    const r=el.getBoundingClientRect();
    return {el, left:r.left, right:r.right, top:r.top, bottom:r.bottom};
  });
}

/* æ£€æµ‹ä¸ç°æœ‰æ¶ˆæ¯æ˜¯å¦é‡å ï¼ˆç•™å‡º marginï¼‰ */
function overlaps(x,y,w,h,existing,margin=8){
  for(const e of existing){
    if(!(x + w + margin < e.left || x > e.right + margin || y + h + margin < e.top || y > e.bottom + margin)){
      return true;
    }
  }
  return false;
}

/* å°è¯•ç”Ÿæˆä¸é‡å ä½ç½® */
function findPositionFor(el){
  const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
  const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
  const rect = el.getBoundingClientRect();
  const w = rect.width, h = rect.height;
  const existing = getVisibleRects();
  for(let i=0;i<TRY_POS_ATTEMPTS;i++){
    const x = Math.random()*(vw - w - 40) + 20;
    const y = Math.random()*(vh - h - 40) + 20;
    if(!overlaps(x,y,w,h,existing)) return {x,y};
  }
  // å¦‚æœå°è¯•å¤±è´¥ï¼Œä»è¿”å›ä¸€ä¸ªä½ç½®ï¼ˆä¸ä¼šæ— é™å¡ä½ï¼‰
  return { x: Math.random()*(vw - w - 40) + 20, y: Math.random()*(vh - h - 40) + 20 };
}

/* åˆ›å»ºå¹¶æ˜¾ç¤ºå•æ¡æ¶ˆæ¯ */
function showSingleMessage(text){
  const el = document.createElement('div');
  el.className = 'msg';
  el.tabIndex = 0;
  el.textContent = text;
  el.dataset.dismiss = '0';
  // æš‚æ”¾åˆ° DOM ä»¥ä¾¿æµ‹é‡å®½é«˜
  barrage.appendChild(el);
  // pointer-events for msg to allow focus/escape
  el.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ removeMsg(el); } });

  // å†³å®šä½ç½®ï¼ˆé¿å…é‡å ï¼‰
  requestAnimationFrame(()=>{
    const pos = findPositionFor(el);
    el.style.left = pos.x + 'px';
    el.style.top = pos.y + 'px';
    // è§†è§‰éšæœºè½»å¾®è‰²è°ƒ
    el.style.background = randomSoftBackground();
    el.style.color = '#0b0b0b';
    // show
    requestAnimationFrame(()=> el.classList.add('show'));
    // éŸ³é¢‘è¾…åŠ©ï¼šè¯»å‡ºåˆ° screen reader
    sr.textContent = text;
    // è‡ªåŠ¨ç§»é™¤
    setTimeout(()=> {
      el.dataset.dismiss = '1';
      el.classList.remove('show');
      setTimeout(()=> el.remove(), 420);
    }, DISPLAY_TIME);
    // é¼ æ ‡æ‚¬åœå»¶é•¿æ˜¾ç¤ºï¼ˆå¯é€‰ï¼‰
    el.addEventListener('mouseenter', ()=> {
      // å»¶é•¿åˆ°é¢å¤– 4sï¼ˆæ¯æ¬¡è¿›å…¥å»¶é•¿ä¸€æ¬¡ï¼‰
      if(el.dataset.dismiss==='0'){
        // cancel previous removal by cloning time logic: set new timeout to remove after DISPLAY_TIME ms again
        // simplified: mark as hovered to avoid early removal
        el.dataset.hover='1';
      }
    });
    el.addEventListener('mouseleave', ()=> { if(el.dataset.hover){ el.dataset.hover='0'; }});
  });
}

/* ç”ŸæˆæŸ”å’ŒèƒŒæ™¯è‰²ï¼ˆHSLï¼‰ */
function randomSoftBackground(){
  const h = Math.floor(330 + Math.random()*40); // pink range
  const s = 70 + Math.floor(Math.random()*10);
  const l = 85 - Math.floor(Math.random()*6);
  return `hsl(${h} ${s}% ${l}%)`;
}

/* å±•ç¤ºä¸€æ‰¹æ¶ˆæ¯ï¼ˆä»æ± ä¸­æŠ½å–ï¼Œä¸é‡å¤ï¼‰ */
function showBatch(){
  if(paused) return;
  const currentVisible = barrage.children.length;
  if(currentVisible >= MAX_SIMULTANEOUS) return; // è¾¾åˆ°å¹¶å‘ä¸Šé™ï¼Œç­‰ä¸‹æ¬¡
  // batch size éšæœºåœ¨ min..maxï¼Œä½†ä¹Ÿä¸è¦è¶…è¿‡å‰©ä½™å¯æ˜¾ç¤ºä½
  const batchSize = Math.min(BATCH_MAX, Math.max(BATCH_MIN, Math.floor(Math.random()*(BATCH_MAX - BATCH_MIN + 1)) + BATCH_MIN - 1));
  let toShow = batchSize;
  // ensure not exceeding MAX_SIMULTANEOUS
  const canShow = MAX_SIMULTANEOUS - currentVisible;
  toShow = Math.min(toShow, canShow);
  for(let i=0;i<toShow;i++){
    if(pool.length===0) refillPool(); // æ± ç©ºäº†å°±é‡ç½®
    const item = pool.pop();
    showSingleMessage(item);
  }
}

/* åˆå§‹å¿«é€Ÿé“ºé¢ï¼ˆå¼€åœºï¼‰ */
function initialBurst(){
  let t = 120;
  for(let i=0;i<INITIAL_BURST;i++){
    setTimeout(()=>{
      if(pool.length===0) refillPool();
      const item = pool.pop();
      showSingleMessage(item);
    }, t);
    t += 220;
  }
}

/* å¾ªç¯èŠ‚å¥ï¼šæ¯ 2.6s å°è¯•ä¸€æ¬¡å±•ç¤ºï¼ˆä½†ä¼šéµå®ˆå¹¶å‘ä¸Šé™å’Œæ± çŠ¶æ€ï¼‰ï¼Œä¸»å¾ªç¯ */
let loopTimer = null;
let paused = false;
function startLoop(){
  if(loopTimer) clearInterval(loopTimer);
  loopTimer = setInterval(()=>{
    // åªæœ‰åœ¨é¡µé¢å¯è§ä¸”éæš‚åœæ—¶å±•ç¤º
    if(document.hidden || paused) return;
    showBatch();
  }, 2600);
}

/* æš‚åœ/ç»§ç»­ å¼¹å¹• */
pauseBtn.addEventListener('click', ()=>{
  paused = !paused;
  pauseBtn.setAttribute('aria-pressed', String(paused));
  pauseBtn.textContent = paused ? 'â–¶ æ¢å¤å¼¹å¹•' : 'â¯ æš‚åœå¼¹å¹•';
});

/* é”®ç›˜å¿«æ·ï¼šç©ºæ ¼åˆ‡æ¢å¼¹å¹•æš‚åœï¼ŒM æ¸…ç©ºå±è¯»æ–‡æœ¬ */
window.addEventListener('keydown', (e)=>{
  if(e.target && (e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA')) return;
  if(e.code === 'Space'){ e.preventDefault(); paused = !paused; pauseBtn.setAttribute('aria-pressed', String(paused)); pauseBtn.textContent = paused ? 'â–¶ æ¢å¤å¼¹å¹•' : 'â¯ æš‚åœå¼¹å¹•'; }
  if(e.key.toLowerCase() === 'm' && e.ctrlKey){ sr.textContent=''; }
});

/* èƒŒæ™¯èŠ±ç“£ / ç²’å­ ï¼ˆç®€æ´ï¼‰ */
const canvas = document.getElementById('bg');
const ctx = canvas.getContext('2d');
let W = canvas.width = innerWidth;
let H = canvas.height = innerHeight;
window.addEventListener('resize', ()=>{ W = canvas.width = innerWidth; H = canvas.height = innerHeight; });
const petals = [];
for(let i=0;i<48;i++) petals.push(makePetal());

function makePetal(){
  return {
    x: Math.random()*W,
    y: Math.random()*H,
    r: 6 + Math.random()*10,
    vx: -0.3 + Math.random()*0.6,
    vy: 0.2 + Math.random()*0.8,
    rot: Math.random()*Math.PI*2,
    rotSpeed: (Math.random()-0.5)*0.02,
    hue: 330 + Math.random()*30,
    alpha: 0.6 + Math.random()*0.3,
  };
}

function drawBg(){
  ctx.clearRect(0,0,W,H);
  for(const p of petals){
    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.rotate(p.rot);
    ctx.fillStyle = `hsla(${p.hue},70%,85%,${p.alpha})`;
    // petal shape as ellipse
    ctx.beginPath();
    ctx.ellipse(0, 0, p.r*0.9, p.r*0.6, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
    p.x += p.vx + Math.sin(p.y/30)*0.2;
    p.y += p.vy;
    p.rot += p.rotSpeed;
    if(p.y > H + 20){ Object.assign(p, makePetal()); p.y = -20; p.x = Math.random()*W; }
    if(p.x < -30) p.x = W + 30;
    if(p.x > W + 30) p.x = -30;
  }
  requestAnimationFrame(drawBg);
}

/* å¯åŠ¨æµç¨‹ */
initialBurst();
startLoop();
drawBg();

/* è‡ªåŠ¨å¼€å§‹éŸ³ä¹æ’­æ”¾ï¼šæ’­æ”¾ä¸€æ¬¡åä¸å¾ªç¯ï¼ˆæµè§ˆå™¨å¯èƒ½é˜»æ­¢è‡ªåŠ¨æ’­æ”¾ï¼‰ */
/* è‹¥è¦â€œä»…æ’­æ”¾ä¸€æ¬¡â€ï¼Œæˆ‘ä»¬ä¸è®¾ç½® loopï¼Œç›‘å¬ ended äº‹ä»¶ */
audio.addEventListener('error', (e)=> {
  // å¦‚æœæ‰¾ä¸åˆ° or æ’­æ”¾å¤±è´¥ï¼Œéšè—éŸ³ä¹æŒ‰é’®æç¤º
  musicBtn.textContent = 'ğŸµ (æ–‡ä»¶æœªå°±ç»ª)';
});
/* è‹¥æµè§ˆå™¨é˜»æ­¢è‡ªåŠ¨æ’­æ”¾ï¼Œåˆ™ç”¨æˆ·ç‚¹å‡» musicBtn å¯ä»¥è§¦å‘æ’­æ”¾ï¼ˆä¸Šé¢ç»‘å®šäº† play/pauseï¼‰ */

/* å°åŠŸèƒ½ï¼šé¦–æ¬¡å¾ªç¯å¼€å§‹æ—¶å°½é‡åœ¨ç¬¬ä¸€è½®å†…æ’­æ”¾æ‰€æœ‰æ¶ˆæ¯ï¼ˆé€šè¿‡æ± é€»è¾‘å·²ä¿è¯ï¼‰ */

/* æ¸…ç†ï¼šå½“é¡µé¢å¸è½½ï¼Œåœæ­¢å®šæ—¶å™¨ */
window.addEventListener('beforeunload', ()=>{ if(loopTimer) clearInterval(loopTimer); });

</script>
</body>
</html>
